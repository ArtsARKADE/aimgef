// Point sets to plot.
const exportPng = false
let maia = {
    "png": "maia_step.png"
}
let transformer = {
    "png": "transformer_step.png"
}
// Point sets to plot.
let p1227 = {
    "pointSet": [
        [
            240,
            60
        ],
        [
            240,
            63
        ],
        [
            240,
            65
        ],
        [
            242,
            59
        ],
        [
            242,
            60
        ],
        [
            242,
            62
        ],
        [
            242,
            64
        ],
        [
            244,
            58
        ],
        [
            244,
            60
        ],
        [
            244,
            63
        ],
        [
            244,
            67
        ],
        [
            247.5,
            59
        ],
        [
            247.5,
            61
        ],
        [
            247.5,
            64
        ],
        [
            247.5,
            66
        ],
        [
            248,
            60
        ],
        [
            248,
            63
        ],
        [
            248,
            65
        ],
        [
            249,
            72
        ],
        [
            250,
            59
        ],
        [
            250,
            60
        ],
        [
            250,
            62
        ],
        [
            251,
            71
        ],
        [
            252,
            58
        ],
        [
            252,
            60
        ],
        [
            252,
            63
        ],
        [
            252,
            74
        ],
        [
            255,
            67
        ]
    ],
    "pixelSet": null
}
let p2353 = {
    "pointSet": [
        [
            496,
            49
        ],
        [
            496,
            58
        ],
        [
            496,
            61
        ],
        [
            497.5,
            61
        ],
        [
            498,
            61
        ],
        [
            498.5,
            61
        ],
        [
            499,
            61
        ],
        [
            499.5,
            61
        ],
        [
            500,
            62
        ],
        [
            500.75,
            61
        ],
        [
            500.875,
            62
        ],
        [
            501,
            61
        ],
        [
            501.5,
            61
        ],
        [
            502,
            61
        ],
        [
            502.5,
            61
        ],
        [
            503,
            61
        ],
        [
            503.5,
            61
        ],
        [
            504,
            56
        ],
        [
            504,
            65
        ],
        [
            504,
            67
        ],
        [
            504,
            68
        ],
        [
            505,
            57
        ],
        [
            505,
            64
        ],
        [
            505,
            66
        ],
        [
            505.5,
            61
        ],
        [
            506,
            61
        ],
        [
            506.5,
            61
        ],
        [
            507,
            61
        ],
        [
            507.5,
            61
        ],
        [
            508,
            57
        ],
        [
            508,
            64
        ],
        [
            508,
            66
        ],
        [
            508,
            68
        ],
        [
            509,
            58
        ],
        [
            509,
            63
        ],
        [
            509,
            65
        ],
        [
            509.5,
            61
        ],
        [
            510,
            61
        ],
        [
            510.5,
            61
        ],
        [
            511,
            61
        ],
        [
            511.5,
            61
        ]
    ],
    "pixelSet": null
}
let p1207 = {
    "pointSet": [
        [
            696,
            52
        ],
        [
            696,
            59
        ],
        [
            697.5,
            53
        ],
        [
            697.5,
            60
        ],
        [
            697.75,
            52
        ],
        [
            697.75,
            59
        ],
        [
            698,
            51
        ],
        [
            698,
            58
        ],
        [
            698.5,
            52
        ],
        [
            698.5,
            59
        ],
        [
            699,
            49
        ],
        [
            699,
            56
        ],
        [
            699.25,
            68
        ],
        [
            699.5,
            70
        ],
        [
            699.75,
            73
        ],
        [
            700,
            59
        ],
        [
            700,
            75
        ],
        [
            700.25,
            73
        ],
        [
            700.5,
            75
        ],
        [
            700.75,
            73
        ],
        [
            701,
            59
        ],
        [
            701,
            75
        ],
        [
            701.25,
            73
        ],
        [
            701.5,
            75
        ],
        [
            701.75,
            73
        ],
        [
            702,
            52
        ],
        [
            702,
            59
        ],
        [
            702,
            76
        ],
        [
            703.5,
            53
        ],
        [
            703.5,
            60
        ],
        [
            703.75,
            52
        ],
        [
            703.75,
            59
        ],
        [
            704,
            51
        ],
        [
            704,
            58
        ],
        [
            704.5,
            52
        ],
        [
            704.5,
            59
        ],
        [
            705,
            50
        ],
        [
            705,
            57
        ],
        [
            705.25,
            69
        ],
        [
            705.5,
            71
        ],
        [
            705.75,
            73
        ],
        [
            706,
            59
        ],
        [
            706,
            76
        ],
        [
            706.25,
            73
        ],
        [
            706.5,
            76
        ],
        [
            706.75,
            73
        ],
        [
            707,
            59
        ],
        [
            707,
            76
        ],
        [
            707.25,
            73
        ],
        [
            707.5,
            76
        ],
        [
            707.75,
            73
        ],
        [
            708,
            57
        ],
        [
            708,
            62
        ],
        [
            708,
            66
        ],
        [
            708,
            76
        ],
        [
            709.5,
            67
        ],
        [
            709.75,
            66
        ],
        [
            710,
            65
        ],
        [
            710.5,
            66
        ],
        [
            711,
            58
        ],
        [
            711,
            67
        ]
    ],
    "pixelSet": null
}
let p39 = {
    "pointSet": [
        [
            40,
            63
        ],
        [
            40,
            65
        ],
        [
            40,
            70
        ],
        [
            40.25,
            65
        ],
        [
            40.25,
            68
        ],
        [
            42,
            62
        ],
        [
            42,
            63
        ],
        [
            42,
            65
        ],
        [
            42,
            67
        ],
        [
            44,
            61
        ],
        [
            44,
            63
        ],
        [
            44,
            66
        ],
        [
            44,
            70
        ],
        [
            47.5,
            62
        ],
        [
            47.5,
            64
        ],
        [
            47.5,
            67
        ],
        [
            47.5,
            69
        ],
        [
            48,
            63
        ],
        [
            48,
            66
        ],
        [
            48,
            68
        ],
        [
            48.5,
            66
        ],
        [
            49,
            66
        ],
        [
            49,
            68
        ],
        [
            51,
            63
        ],
        [
            51,
            70
        ],
        [
            52,
            64
        ],
        [
            52,
            70
        ],
        [
            54,
            69
        ]
    ],
    "pixelSet": null,
}
let p116 = {
    "pointSet": [
        [
            51.125,
            48
        ],
        [
            51.625,
            48
        ],
        [
            52.125,
            48
        ],
        [
            53.125,
            48
        ],
        [
            53.625,
            48
        ],
        [
            54.125,
            48
        ],
        [
            54.625,
            48
        ],
        [
            55.125,
            48
        ],
        [
            56.125,
            48
        ],
        [
            56.625,
            48
        ],
        [
            57.125,
            48
        ],
        [
            57.625,
            48
        ],
        [
            58.125,
            48
        ],
        [
            58.625,
            48
        ],
        [
            59.125,
            48
        ],
        [
            59.625,
            48
        ],
        [
            60.125,
            48
        ],
        [
            60.625,
            48
        ],
        [
            61.125,
            48
        ],
        [
            61.625,
            48
        ],
        [
            62.125,
            48
        ],
        [
            62.625,
            48
        ],
        [
            63.125,
            48
        ],
        [
            63.625,
            48
        ],
        [
            64.125,
            48
        ],
        [
            64.625,
            48
        ],
        [
            65.625,
            48
        ],
        [
            65.625,
            57
        ],
        [
            65.625,
            62
        ],
        [
            66.125,
            48
        ],
        [
            66.625,
            48
        ],
        [
            67.125,
            48
        ],
        [
            67.625,
            48
        ]
    ],
    "pixelSet": null
}
let p249 = {
    "pointSet": [
        [
            13.5,
            58
        ],
        [
            15.25,
            58
        ],
        [
            16,
            51
        ],
        [
            16,
            58
        ],
        [
            16.5,
            48
        ],
        [
            16.5,
            55
        ],
        [
            16.75,
            67
        ],
        [
            17,
            69
        ],
        [
            17.25,
            72
        ],
        [
            17.5,
            58
        ],
        [
            17.5,
            74
        ],
        [
            17.75,
            72
        ],
        [
            18,
            74
        ],
        [
            18.25,
            72
        ],
        [
            18.5,
            58
        ],
        [
            18.5,
            74
        ],
        [
            18.75,
            72
        ],
        [
            19,
            74
        ],
        [
            19.25,
            72
        ],
        [
            19.5,
            51
        ],
        [
            19.5,
            58
        ],
        [
            19.5,
            75
        ],
        [
            21,
            52
        ],
        [
            21,
            59
        ],
        [
            21.25,
            51
        ],
        [
            21.25,
            58
        ],
        [
            21.5,
            50
        ],
        [
            21.5,
            57
        ],
        [
            22,
            51
        ],
        [
            22,
            58
        ],
        [
            22.5,
            49
        ],
        [
            22.5,
            56
        ],
        [
            22.75,
            68
        ],
        [
            23,
            70
        ],
        [
            23.25,
            72
        ],
        [
            23.5,
            58
        ],
        [
            23.5,
            75
        ],
        [
            23.75,
            72
        ],
        [
            24,
            75
        ],
        [
            24.25,
            72
        ],
        [
            24.5,
            58
        ],
        [
            24.5,
            75
        ],
        [
            24.75,
            72
        ],
        [
            25,
            75
        ],
        [
            25.25,
            72
        ],
        [
            25.5,
            56
        ],
        [
            25.5,
            61
        ],
        [
            25.5,
            65
        ],
        [
            25.5,
            75
        ],
        [
            27,
            66
        ],
        [
            27.25,
            65
        ],
        [
            27.5,
            64
        ],
        [
            28,
            65
        ],
        [
            28.5,
            57
        ],
        [
            28.5,
            66
        ],
        [
            30.5,
            59
        ],
        [
            30.5,
            61
        ],
        [
            31.5,
            73
        ]
    ],
    "pixelSet": null
}
// We want the plots to fit in whatever the width and height are, but we also want
// them to be at the same scale.

function preload() {
    maia.img = loadImage(maia.png)
    transformer.img = loadImage(transformer.png)
}

function pointsetplot(x, y, px, py) {
    x.pixelSet = px.pointSet.map(function(p) {
        const propX = (p[0] - x.minX) / x.rngX
        const propY = (p[1] - x.minY) / x.rngY
        const pixlX = x.x + propX * x.width * x.sfX
        const pixlY = x.y - propY * x.height * x.sfY
        ellipse(
            pixlX, pixlY, 10, 10
        )
        return [pixlX, pixlY]
    })
    // rect(240, 760, 1000, 1000)


    y.pixelSet = py.pointSet.map(function(p) {
        const propX = (p[0] - y.minX) / (y.maxX - y.minX)
        const propY = (p[1] - y.minY) / (y.maxY - y.minY)
        const pixlX = y.x + propX * y.width * y.sfX
        const pixlY = y.y - propY * y.height * y.sfY
        ellipse(
            pixlX, pixlY, 10, 10
        )
        return [pixlX, pixlY]
    })

    // Draw axis
    line(x.x - x.ppb, x.y + x.ppp, x.x - x.ppb, x.y - x.height * x.sfY - x.ppp);
    line(x.x - x.ppb, x.y + x.ppp, x.x + x.width * x.sfX + x.ppb, x.y + x.ppp);
    line(y.x - y.ppb, y.y + y.ppp, y.x - y.ppb, y.y - y.height * y.sfY - y.ppp);
    line(y.x - y.ppb, y.y + y.ppp, y.x + y.width * y.sfX + y.ppb, y.y + y.ppp);
    // Draw scale
    textSize(24)
    for (let i = 0; i < x.rngY / 5; i++) {
        line(x.x - x.ppb, x.y + x.ppp - x.ppp * 5 * (i), x.x - x.ppb - 10, x.y + x.ppp - x.ppp * 5 * (i));
        text(`${x.minY + 5 * i - 1}`, x.x - x.ppb - 45, x.y + x.ppp - x.ppp * 5 * (i) + 8);
        line(y.x - y.ppb, y.y + y.ppp - y.ppp * 5 * (i), y.x - y.ppb - 10, y.y + y.ppp - y.ppp * 5 * (i));
        text(`${y.minY + 5 * i - 1}`, y.x - y.ppb - 45, y.y + y.ppp - y.ppp * 5 * (i) + 8);
    }
    for (let i = 0; i < x.rngX; i++) {
        let rx = 1 - x.minX % 1
        let ry = 1 - y.minX % 1
        if (rx === 1) {
            line(x.x + x.ppb * 4 * (i), x.y + x.ppp, x.x + x.ppb * 4 * (i), x.y + x.ppp + 10);
            text(`${x.minX + i}`, x.x + x.ppb * 4 * (i) - 8, x.y + x.ppp + 40);
        } else {
            line(x.x + x.ppb * (4 * (i) + rx), x.y + x.ppp, x.x + x.ppb * (4 * (i) + rx), x.y + x.ppp + 10);
            text(`${x.minX + rx + i}`, x.x + x.ppb * 4 * (i) - 8, x.y + x.ppp + 40);
        }
        if (ry === 1) {
            line(y.x + y.ppb * 4 * (i), y.y + y.ppp, y.x + y.ppb * 4 * (i), y.y + y.ppp + 10);
            text(`${y.minX + i}`, y.x + y.ppb * 4 * (i) - 8, y.y + y.ppp + 40)
        } else {
            line(y.x + y.ppb * (4 * (i) + ry), y.y + y.ppp, y.x + y.ppb * (4 * (i) + ry), y.y + y.ppp + 10);
            text(`${y.minX + ry + i}`, y.x + y.ppb * 4 * (i) - 8, y.y + y.ppp + 40)
        }
    }
    textSize(28)
    push()
    translate(x.x - x.ppb - 45, x.y - x.height - 50)
    rotate(PI * 1.5)
    text("Pitch (MPN)", -350, -30);
    pop()
    push()
    translate(y.x - y.ppb - 45, y.y - y.height - 50)
    rotate(PI * 1.5)
    text("Pitch (MPN)", -350, -30);
    pop()
    text("Ontime (Crotchet Beats)", x.x + x.width / 2.5, x.y + x.ppb + 100);
    text("Ontime (Crotchet Beats)", y.x + y.width / 2.5, y.y + y.ppb + 100);


    // Draw arrows in one colour if there is a match, and in a different colour if there is not.
    y.idxInX = py.pointSet.map(function(p) {
        const pTrans = mu.subtract_two_arrays(p, x.transVec)
        console.log("pTrans:", pTrans)
        const relIdx = px.pointSet.findIndex(function(q) {
            return pTrans.equals(q)
        })
        return relIdx
        console.log(relIdx)
    })

    y.idxInX.forEach(function(idx, jdx) {
        if (idx >= 0) {
            stroke(0, 50)
            line(
                x.pixelSet[idx][0], x.pixelSet[idx][1],
                y.pixelSet[jdx][0], y.pixelSet[jdx][1]
            )
        } else {
            stroke(0, 5)
        }

    })
    stroke(51)
}

function setup() {
    let param = {
        "cvWidth": 3200,
        "cvHeight": 3000,
        "p39": {
            "transVec": [200, -3],
            "name": "p39",
            "x": 150,
            "y": 1300,
            "width": 1000,
            "height": 500,
            "card": p39.pointSet.length,
            "minX": mu.min_argmin(p39.pointSet.map(function(p) {
                return p[0]
            }))[0],
            "maxX": mu.max_argmax(p39.pointSet.map(function(p) {
                return p[0]
            }))[0],
            "minY": mu.min_argmin(p39.pointSet.map(function(p) {
                return p[1]
            }).concat(p1227.pointSet.map(function(p) {
                return p[1]
            })))[0],
            "maxY": mu.max_argmax(p39.pointSet.map(function(p) {
                return p[1]
            }).concat(p1227.pointSet.map(function(p) {
                return p[1]
            })))[0]
        },

        "p1227": {
            "name": "p1227",
            "x": 1750,
            "y": 1300,
            "width": 1000,
            "height": 500,
            "card": p1227.pointSet.length,
            "minX": mu.min_argmin(p1227.pointSet.map(function(p) {
                return p[0]
            }))[0],
            "maxX": mu.max_argmax(p1227.pointSet.map(function(p) {
                return p[0]
            }))[0],
            "minY": mu.min_argmin(p1227.pointSet.map(function(p) {
                return p[1]
            }).concat(p39.pointSet.map(function(p) {
                return p[1]
            })))[0],
            "maxY": mu.max_argmax(p1227.pointSet.map(function(p) {
                return p[1]
            }).concat(p39.pointSet.map(function(p) {
                return p[1]
            })))[0]
        },

        "p116": {
            "transVec": [443.875, 13],
            "name": "p116",
            "x": 150,
            "y": 2100,
            "width": 1000,
            "height": 500,
            "card": p116.pointSet.length,
            "minX": mu.min_argmin(p116.pointSet.map(function(p) {
                return p[0]
            }))[0],
            "maxX": mu.max_argmax(p116.pointSet.map(function(p) {
                return p[0]
            }))[0],
            "minY": mu.min_argmin(p116.pointSet.map(function(p) {
                return p[1]
            }).concat(p2353.pointSet.map(function(p) {
                return p[1]
            })))[0],
            "maxY": mu.max_argmax(p116.pointSet.map(function(p) {
                return p[1]
            }).concat(p2353.pointSet.map(function(p) {
                return p[1]
            })))[0]
        },

        "p2353": {
            "name": "p2353",
            "x": 1750,
            "y": 2100,
            "width": 1000,
            "height": 500,
            "card": p1227.pointSet.length,
            "minX": mu.min_argmin(p2353.pointSet.map(function(p) {
                return p[0]
            }))[0],
            "maxX": mu.max_argmax(p2353.pointSet.map(function(p) {
                return p[0]
            }))[0],
            "minY": mu.min_argmin(p2353.pointSet.map(function(p) {
                return p[1]
            }).concat(p116.pointSet.map(function(p) {
                return p[1]
            })))[0],
            "maxY": mu.max_argmax(p2353.pointSet.map(function(p) {
                return p[1]
            }).concat(p116.pointSet.map(function(p) {
                return p[1]
            })))[0]
        },

        "p249": {
            "transVec": [682.5, 1],
            "name": "p249",
            "x": 150,
            "y": 2900,
            "width": 1000,
            "height": 500,
            "card": p249.pointSet.length,
            "minX": mu.min_argmin(p249.pointSet.map(function(p) {
                return p[0]
            }))[0],
            "maxX": mu.max_argmax(p249.pointSet.map(function(p) {
                return p[0]
            }))[0],
            "minY": mu.min_argmin(p249.pointSet.map(function(p) {
                return p[1]
            }).concat(p1207.pointSet.map(function(p) {
                return p[1]
            })))[0],
            "maxY": mu.max_argmax(p249.pointSet.map(function(p) {
                return p[1]
            }).concat(p1207.pointSet.map(function(p) {
                return p[1]
            })))[0]
        },

        "p1207": {
            "name": "p1207",
            "x": 1750,
            "y": 2900,
            "width": 1000,
            "height": 500,
            "card": p1207.pointSet.length,
            "minX": mu.min_argmin(p1207.pointSet.map(function(p) {
                return p[0]
            }))[0],
            "maxX": mu.max_argmax(p1207.pointSet.map(function(p) {
                return p[0]
            }))[0],
            "minY": mu.min_argmin(p1207.pointSet.map(function(p) {
                return p[1]
            }).concat(p249.pointSet.map(function(p) {
                return p[1]
            })))[0],
            "maxY": mu.max_argmax(p1207.pointSet.map(function(p) {
                return p[1]
            }).concat(p249.pointSet.map(function(p) {
                return p[1]
            })))[0]
        },

    }
    param.p39.rngX = Math.max(param.p39.maxX - param.p39.minX, param.p1227.maxX - param.p1227.minX)
    param.p116.rngX = Math.max(param.p116.maxX - param.p116.minX, param.p2353.maxX - param.p2353.minX)
    param.p249.rngX = Math.max(param.p249.maxX - param.p249.minX, param.p1207.maxX - param.p1207.minX)
    param.p1227.rngX = Math.max(param.p39.maxX - param.p39.minX, param.p1227.maxX - param.p1227.minX)
    param.p2353.rngX = Math.max(param.p116.maxX - param.p116.minX, param.p2353.maxX - param.p2353.minX)
    param.p1207.rngX = Math.max(param.p249.maxX - param.p249.minX, param.p1207.maxX - param.p1207.minX)

    param.p39.rngY = param.p39.maxY - param.p39.minY
    param.p116.rngY = param.p116.maxY - param.p116.minY
    param.p249.rngY = param.p249.maxY - param.p249.minY
    param.p1227.rngY = param.p1227.maxY - param.p1227.minY
    param.p2353.rngY = param.p2353.maxY - param.p2353.minY
    param.p1207.rngY = param.p1207.maxY - param.p1207.minY
    param.p39.sfX = 1
    param.p39.sfY = 1
    param.p116.sfX = 1
    param.p116.sfY = 1
    param.p249.sfX = 1
    param.p249.sfY = 1
    param.p1227.sfX = 1
    param.p1227.sfY = 1
    param.p2353.sfX = 1
    param.p2353.sfY = 1
    param.p1207.sfX = 1
    param.p1207.sfY = 1
    if (param.p39.rngX >= param.p1227.rngX) {
        param.p1227.sfX = param.p1227.rngX / param.p39.rngX
    } else {
        param.p39.sfX = param.p39.rngX / param.p1227.rngX
    }
    if (param.p116.rngX >= param.p2353.rngX) {
        param.p2353.sfX = param.p2353.rngX / param.p116.rngX
    } else {
        param.p116.sfX = param.p116.rngX / param.p2353.rngX
    }
    if (param.p249.rngX >= param.p1207.rngX) {
        param.p1207.sfX = param.p1207.rngX / param.p249.rngX
    } else {
        param.p249.sfX = param.p249.rngX / param.p1207.rngX
    }


    param.p39.ppp = 1 / param.p39.rngY * param.p39.height * param.p39.sfY
    param.p1227.ppp = 1 / param.p1227.rngY * param.p1227.height * param.p1227.sfY
    param.p39.ppb = 0.25 / param.p39.rngX * param.p39.width * param.p39.sfX
    param.p1227.ppb = 0.25 / param.p1227.rngX * param.p1227.width * param.p1227.sfX

    param.p116.ppp = 1 / param.p116.rngY * param.p116.height * param.p116.sfY
    param.p2353.ppp = 1 / param.p2353.rngY * param.p2353.height * param.p2353.sfY
    param.p116.ppb = 0.25 / param.p116.rngX * param.p116.width * param.p116.sfX
    param.p2353.ppb = 0.25 / param.p2353.rngX * param.p2353.width * param.p2353.sfX

    param.p249.ppp = 1 / param.p249.rngY * param.p249.height * param.p249.sfY
    param.p1207.ppp = 1 / param.p1207.rngY * param.p1207.height * param.p1207.sfY
    param.p249.ppb = 0.25 / param.p249.rngX * param.p249.width * param.p249.sfX
    param.p1207.ppb = 0.25 / param.p1207.rngX * param.p1207.width * param.p1207.sfX

    let c = createCanvas(3200, 3100)
    background(255)
    stroke(51)
    let imgWidth = 1000
    // Add the PNG files.
    let aspectRatio = maia.img.height / maia.img.width
    image(
        maia.img, 20, 20,
        imgWidth, aspectRatio * imgWidth
    )
    aspectRatio = transformer.img.height / transformer.img.width
    image(
        transformer.img, 1620, 20,
        imgWidth, aspectRatio * imgWidth
    )

    pointsetplot(param.p39, param.p1227, p39, p1227)
    pointsetplot(param.p116, param.p2353, p116, p2353)
    pointsetplot(param.p249, param.p1207, p249, p1207)

    // console.log("p2322:", p2322)
    textStyle(BOLD)
    textSize(48)
    text("a", 20, 50)
    text("b", 1600, 50)
    text("c", 20, 700)
    text("d", 20, 1500)
    text("e", 20, 2300)

    if (exportPng) {
        saveCanvas(c, 'myCanvas', 'png')
    }

}